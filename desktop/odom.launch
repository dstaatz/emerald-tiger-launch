<!-- Copyright (C) 2020 Dylan Staatz - All Rights Reserved. -->

<launch>

    <arg name="imu_serial_port" default="/dev/ttyUSB0"/>
    <arg name="lidar_serial_port" default="/dev/rplidar"/>
    
    <machine name="dylan-pi3" address="dylan-pi3" env-loader="./setup_pi_ws.sh"/>

    <!-- Reading imu data from bno055 through serial -->
    <node machine="dylan-pi3" pkg="ros_imu_bno055" type="imu_ros.py" name="ros_imu_bno055_node" output="screen">
        <param name="serial_port" value="$(arg imu_serial_port)"/>
        <param name="frame_id" value="imu"/>
        <param name="operation_mode" value="IMU"/>
        <param name="oscillator" value="EXTERNAL"/>
        <param name="reset_orientation" value = "true"/>
        <param name="frequency" value="50"/>
        <param name="use_magnetometer" value="false"/>    
        <param name="use_temperature" value="false"/>    
    </node>

    <!-- Lidar scanner driver -->
    <node machine="dylan-pi3" name="rplidarNode"  pkg="rplidar_ros"  type="rplidarNode"  output="screen">
        <param name="serial_port"           type="string"   value="$(arg lidar_serial_port)"/>
        <param name="serial_baudrate"       type="int"      value="115200"/><!--A1/A2 -->
        <!--param name="serial_baudrate"    type="int"      value="256000"--><!--A3 -->
        <param name="frame_id"              type="string"   value="laser"/>
        <param name="inverted"              type="bool"     value="false"/>
        <param name="angle_compensate"      type="bool"     value="true"/>
    </node>

    <!-- Static frame (base -> scan) -->
    <!-- For my robot, the laser scanner is 3 cm in front of the imu using this coordinate frame: https://raw.githubusercontent.com/robopeak/rplidar_ros/master/rplidar_A1.png -->
    <node pkg="tf" type="static_transform_publisher" name="base_scan_broadcaster" args="-0.03 0 0 0 0 0 base scan 100"/>

    <!-- Static frame (base -> imu) -->
    <!-- For my robot, the imu scanner is rotated 90 degrees counterclockwise from this frame: https://raw.githubusercontent.com/robopeak/rplidar_ros/master/rplidar_A1.png -->
    <node pkg="tf" type="static_transform_publisher" name="base_imu_broadcaster" args="0 0 0 0 -1.570796 0 base imu 100"/>

    <!-- Combines scans and imu data to form (odom -> base) frame -->
    <node pkg="laser_scan_matcher" type="laser_scan_matcher_node" name="laser_scan_matcher_node" output="screen">
        <param name="fixed_frame"           value="odom"/>
        <param name="base_frame"            value="base"/>
        <param name="use_imu"               value="true"/>
        <param name="use_odom"              value="false"/>
        <param name="use_vel"               value="false"/>
        <param name="publish_tf"            value="true"/>
        <param name="publish_pose"          value="false"/>
        <param name="publish_pose_stamped"  value="false"/>
    </node>

</launch>
